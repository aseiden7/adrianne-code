<!-- # Reading DPT files
This code is modified from code by Stephany Soledad Chacon, "Box> Salk Institute Project> Salk Data> FTIR_Intact_decomposition_pots> FTIR_analysis.Rmd". Using data in the DPT format, we can extrapolate sample attributes from the file names, then normalize and visualize spectra across replicates, crops, and timepoints. The width of the line bounding the spectra represents the range of the data.
```{r dpt-setup, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(ggplot2)
library(ggridges)
library(readr)
library(stringr)
library(viridis)
library(dplyr)
library(cowplot)
library(grid)
library(ggsignif)

# set Box path
box_base <- Sys.getenv("BOX_BASE")
if (box_base == "") stop("BOX_BASE environment variable is not set!")
# set dpt_folder path
dpt_folder <- file.path(box_base, "Salk Institute Project/AKS Salk files/Adrianne_FTIRdata/DPT_files")
```
## Importing FTIR data using readr

### Define file path and import multiple files into one data frame
```{r create-dpt-csv, message=FALSE, warning=FALSE}
# Load required libraries
library(readr)
library(dplyr)
library(tidyr)


# Check if folder exists and list files
if (!dir.exists(dpt_folder)) {
  stop("Directory does not exist: ", dpt_folder)
}

# List and sort files
cat("Files found in directory:\n")
print(list.files(dpt_folder))
DPTfiles <- sort(# nolint: object_name_linter.
                 list.files(dpt_folder, pattern = ".dpt"))

cat("Number of .dpt files:", length(DPTfiles), "\n")

# Read files individually and combine
dpt_data_list <- list()

for (i in seq_along(DPTfiles)) {
  file_path <- file.path(dpt_folder, DPTfiles[i])

  # Read individual file
  temp_data <- readr::read_delim(file_path,
                                 delim = " ",
                                 col_names = c("wavenumber", "absorbance"),
                                 show_col_types = FALSE,
                                 skip_empty_rows = TRUE,
                                 skip = 0)

  # Add filename column
  temp_data$filename <- DPTfiles[i]

  # Store in list
  dpt_data_list[[i]] <- temp_data
}

# Combine all data
dpt_data <- bind_rows(dpt_data_list)

# Convert absorbance to numeric (handle any parsing issues)
dpt_data$absorbance <- as.numeric(dpt_data$absorbance)

# Remove any rows with NA values that might have been created during parsing
dpt_data <- dpt_data[complete.cases(dpt_data), ]

# filter out KBr
dpt_data <- dpt_data[!grepl("KBr", dpt_data$filename), ]

#filter out anomalous spectra
anomalous_spectra <- c("DRIFTS_pot103_13Crice_wk0_root_recNMR_250725.0.dpt",
                       "DRIFTS_pot103_13Crice_wk0_root_vial1_250725.0.dpt",
                       "DRIFTS_pot079_13Crice_wk0_root_250725.0.dpt")

dpt_data <- dpt_data[!dpt_data$filename %in% anomalous_spectra, ]

# Create wide format table
dfw <- dpt_data %>%
  pivot_wider(names_from = filename,
              values_from = absorbance)

# Save to CSV with today's date
today <- Sys.Date()
csvName <- paste0(outputs_folder, "/FTIR_wide_", today, ".csv") # nolint: object_name_linter.
write_csv(dfw, csvName)
```

### Extract sample info from filename
Using the long format dataframe `dpt_data`
**format example: DRIFTS_pot094_13Csoy_wk10_soil_250630.0.dpt**
```{r extract-sample-info, message=FALSE, warning=FALSE}
# First, let's check what our data looks like
cat("Column filenames:", colnames(dpt_data), "\n")

# Extract pot/jar identifier
dpt_data$source <- sapply(strsplit(dpt_data$filename, "_"), function(x) {
  pot_part <- x[2]
  # Extract just "pot" or "jar" part
  if (grepl("pot", pot_part)) {
    "pot"
  } else if (grepl("jar", pot_part)) {
    "jar"
  } else {
    "unknown"
  }
})
unique(dpt_data$source)

# Extract ID number
dpt_data$ID <- sapply(strsplit(dpt_data$filename, "_"), function(x) {
  pot_part <- x[2]
  # Extract numbers from pot/jar identifier
  number <- gsub("(pot|jar)", "", pot_part)
  number
})
unique(dpt_data$ID)

# Extract isotope information (13C or 12C)
dpt_data$isotope <- sapply(strsplit(dpt_data$filename, "_"), function(x) {
  # Look for the part with isotope info (usually position 3)
  isotope_part <- x[3]
  if (grepl("13C", isotope_part)) {
    13
  } else if (grepl("12C", isotope_part)) {
    12
  } else {
    "unknown"
  }
})
unique(dpt_data$isotope)

# Extract crop type (remove isotope numbers)
dpt_data$crop <- sapply(strsplit(dpt_data$filename, "_"), function(x) {
  isotope_part <- x[3]
  # Remove 13C or 12C prefix
  crop <- gsub("^(13C|12C)", "", isotope_part)
  crop
})
unique(dpt_data$crop)

# Extract timepoint
dpt_data$timepoint <- sapply(strsplit(dpt_data$filename, "_"), `[`, 4)
unique(dpt_data$timepoint)

# Extract sample type (root, soil, etc.) - usually position 5
dpt_data$type <- sapply(strsplit(dpt_data$filename, "_"), `[`, 5)
unique(dpt_data$type)

# Extract run date
# find last segment
dpt_data$run_date <- sapply(dpt_data$filename, function(x) {
  segments <- strsplit(x, "_")[[1]]
  last_segment <- segments[length(segments)]
  date <- gsub("\\..*$", "", last_segment) # Remove .dpt extension
})
unique(dpt_data$run_date)

# Extract notes
dpt_data$notes <- sapply(dpt_data$filename, function(x) {
  # Look for the part with notes (usually position 6)
  segments <- strsplit(x, "_")[[1]]
  if (length(segments) > 6) {
    notes_part <- segments[6]
  } else {
    notes_part <- NA
  }
})
unique(dpt_data$notes)
head(dpt_data)

# Create wide format table
dfw2 <- dpt_data %>%
  pivot_wider(names_from = filename,
              values_from = absorbance)

# Save to CSV with today's date
today <- Sys.Date()
csvName2 <- paste0(outputs_folder, "/FTIR_wide_info_", today, ".csv")
write_csv(dfw2, csvName2)
```
### Normalize absorbance data
For each file, create a normalized absorbance column (nabs) by dividing each absorbance value by the maximum absorbance for that file.
```{r plots, message=FALSE, warning=FALSE}
library(tidyverse)
library(gridExtra)
library(cowplot)
library(grid)
library(ggsignif)
library(viridis)
library(ggridges)
library(knitr)
library(gridExtra)

roots <- dpt_data %>% filter(type == "root")
soil <- dpt_data %>% filter(type == "soil")
palc1 <- c("noPlant" = "#7B41A9", "rice" = "#FC9D33",
           "wheat" = "#98C65D", "soy" = "#FE318E")

# Normalize absorbance values
rootsn <- roots %>%
  group_by(filename) %>%
  mutate(nabs = absorbance / max(absorbance))

soiln <- soil %>%
  group_by(filename) %>%
  mutate(nabs = absorbance / max(absorbance))
```

## Plotting by timepoint and type
These plots are of normalized absorbance values. The thickness of the opaque line represents the range of the data. Dotted lines at specific wavenumbers indicate key absorption features.

- 2900 cm<sup>-1</sup> ← aliphatic (alkanes)
- 1730 - 1650 cm<sup>-1</sup> ← carbonyl; C=O stretch (carbonyl, carboxylic acids, esters, ketones, etc.)
- 1500 cm<sup>-1</sup> ← aromatic
  
I'm not sure if these are the best areas to highlight, but I kept what Stephany did.

### Week 0
```{r plotting wk0, message=FALSE, warning=FALSE, comment=FALSE, fig.width=9, fig.height=6}
palc1 <- c("noPlant" = "#7B41A9", "rice" = "#FC9D33",
           "wheat" = "#98C65D", "soy" = "#FE318E")
#roots week 0
root0 <- rootsn %>%
  filter(timepoint == "wk0") %>%
  filter(ID != "047") %>% # 47 has a weird peak at the start
  mutate(crop = factor(crop, levels = c("noPlant", "wheat", "rice", "soy")))
#Plot
root0_plot <- root0 %>%
  ggplot(mapping = aes(x = wavenumber,
                       y = crop,
                       height = nabs,
                       group = crop,
                       fill = crop,
                       color = crop)) +
  geom_density_ridges(stat = "identity",
                      scale = 3,
                      alpha = 0.25) +
 geom_vline(xintercept = 1500, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 1550, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 1580, linetype = "dashed", linewidth = 0.5) +
  geom_vline(xintercept = 1660, linetype = "dashed", linewidth = 0.5) +
  geom_vline(xintercept = 2839, linetype = "longdash", linewidth = 0.5) +
  # geom_vline(xintercept = 2870, linetype = "longdash", linewidth = 0.5) +
  # geom_vline(xintercept = 2898, linetype = "longdash", linewidth = 0.5) +
  geom_vline(xintercept = 2976, linetype = "longdash", linewidth = 0.5) +
  xlim(4000, 400) +
  theme_classic() +
  scale_fill_manual(values = palc1) +
  scale_color_manual(values = palc1) +
  ggtitle("Roots at week 0")
root0_plot
unique(root0$ID)
ggsave(file.path(outputs_folder, "Root_week0_FTIR.png"), plot = root0_plot)


# Soils week 0
# soil0 <- soiln %>% # nolint: commented_code_linter.
#   filter(timepoint == "wk0") # nolint
# soil0

# palc1 <- c("noPlant" = "#7B41A9", "rice" = "#FC9D33",
#            "wheat" = "#98C65D", "soy" = "#FE318E")

# soil0_plot <- soil0 %>% # nolint: commented_code_linter.
#   ggplot(mapping = aes(x = wavenumber,
#                        y = crop, # nolint: commented_code_linter.
#                        height = nabs, # nolint: commented_code_linter.
#                        group = crop, # nolint: commented_code_linter.
#                        fill = crop, # nolint: commented_code_linter.
#                        color = crop)) +
#   geom_density_ridges(stat = "identity",
#                       scale = 3, # nolint: commented_code_linter.
#                       alpha = 0.25) +
#   geom_vline(xintercept = 1650, linetype = "dotted", linewidth = 0.5) +
#   geom_vline(xintercept = 1730, linetype = "dotted", linewidth = 0.5) +
#   geom_vline(xintercept = 1500, linetype = "dotted", linewidth = 0.5) +
#   geom_vline(xintercept = 2900, linetype = "dotted", linewidth = 0.5) +
#   xlim(4000, 400) +
#   theme_classic() +
#   scale_fill_manual(values = palc1) +
#   scale_color_manual(values = palc1) +
#   ggtitle("Soils at week 0") # nolint: commented_code_linter.
# soil0_plot
# unique(soil0$ID) # nolint: commented_code_linter.
# ggsave(file.path(outputs_folder, "Soil_week0_FTIR.png"), plot = soil0_plot) # nolint
```

### Week 10
```{r plotting wk10, message=FALSE, warning=FALSE, fig.width=9, fig.height=6}
palc1 <- c("noPlant" = "#7B41A9", "rice" = "#FC9D33",
           "wheat" = "#98C65D", "soy" = "#FE318E")
#roots week 10
root10 <- rootsn %>%
  filter(timepoint == "wk10") %>%
  filter(ID != "094") %>% # 94 has a huge ~3500 peak compared to other wk10 soy
  mutate(crop = factor(crop, levels = c("noPlant", "wheat", "rice", "soy")))
#Plot
#Plot
root10_plot <- root10 %>%
  ggplot(mapping = aes(x = wavenumber,
                       y = crop,
                       height = nabs,
                       group = crop,
                       fill = crop,
                       color = crop)) +
  geom_density_ridges(stat = "identity",
                      scale = 3,
                      alpha = 0.25) +
  geom_vline(xintercept = 1500, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 1550, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 1580, linetype = "dashed", linewidth = 0.5) +
  geom_vline(xintercept = 1660, linetype = "dashed", linewidth = 0.5) +
  geom_vline(xintercept = 2839, linetype = "longdash", linewidth = 0.5) +
  # geom_vline(xintercept = 2870, linetype = "longdash", linewidth = 0.5) +
  # geom_vline(xintercept = 2898, linetype = "longdash", linewidth = 0.5) +
  geom_vline(xintercept = 2976, linetype = "longdash", linewidth = 0.5) +
  xlim(4000, 400) +
  theme_classic() +
  scale_fill_manual(values = palc1) +
  scale_color_manual(values = palc1) +
  ggtitle("Roots at week 10")
root10_plot
unique(root10$ID)
ggsave(file.path(outputs_folder, "Root_week10_FTIR.png"), plot = root10_plot)

# Soils week 10
soil10 <- soiln %>%
  filter(timepoint == "wk10") %>%
  mutate(crop = factor(crop, levels = c("noPlant", "wheat", "rice", "soy")))

palc1 <- c("noPlant" = "#7B41A9", "rice" = "#FC9D33",
           "wheat" = "#98C65D", "soy" = "#FE318E")

soil10_plot <- soil10 %>%
  ggplot(mapping = aes(x = wavenumber,
                       y = crop,
                       height = nabs,
                       group = crop,
                       fill = crop,
                       color = crop)) +
  geom_density_ridges(stat = "identity",
                      scale = 3,
                      alpha = 0.25) +
  geom_vline(xintercept = 1650, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 1730, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 1500, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 2900, linetype = "dotted", linewidth = 0.5) +
  xlim(4000, 400) +
  theme_classic() +
  scale_fill_manual(values = palc1) +
  scale_color_manual(values = palc1) +
  ggtitle("Soils at week 10")
soil10_plot
unique(soil10$ID)
ggsave(file.path(outputs_folder, "Soil_week10_FTIR.png"), plot = soil10_plot)
```

### Week 40
```{r plotting wk40, message=FALSE, warning=FALSE, fig.width=9, fig.height=6}
palc1 <- c("noPlant" = "#7B41A9", "rice" = "#FC9D33",
           "wheat" = "#98C65D", "soy" = "#FE318E")
#roots week 40
root40 <- rootsn %>%
  filter(timepoint == "wk40") %>%
  mutate(crop = factor(crop, levels = c("noPlant", "wheat", "rice", "soy")))
#Plot
root40_plot <- root40 %>%
  ggplot(mapping = aes(x = wavenumber,
                       y = crop,
                       height = nabs,
                       group = crop,
                       fill = crop,
                       color = crop)) +
  geom_density_ridges(stat = "identity",
                      scale = 3,
                      alpha = 0.25) +
  geom_vline(xintercept = 1730, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 1650, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 1500, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 2900, linetype = "dotted", linewidth = 0.5) +
  xlim(4000, 400) +
  theme_classic() +
  scale_fill_manual(values = palc1) +
  scale_color_manual(values = palc1) +
  ggtitle("Roots at week 40")
root40_plot
unique(root40$ID)
ggsave(file.path(outputs_folder, "Root_week40_FTIR.png"), plot = root40_plot)

```

## Plotting by crop

These plots are of normalized absorbance values. The thickness of the line represents the range of the data. Dotted lines at specific wavenumbers indicate peaks attributed to suberin in:  
White, K. E., Reeves, J. B., & Coale, F. J. (2011). Mid-infrared diffuse reflectance spectroscopy for the rapid analysis of plant root composition. Geoderma, 167–168, 197–203. https://doi.org/10.1016/j.geoderma.2011.08.009    
or   
White, K. E., Reeves, J. B., & Coale, F. J. (2016). Cell wall compositional changes during incubation of plant roots measured by mid-infrared diffuse reflectance spectroscopy and fiber analysis. Geoderma, 264, 205–213. https://doi.org/10.1016/j.geoderma.2015.10.018


- peaks in the 3000 cm<sup>-1</sup> to 2800 cm<sup>-1</sup> range ← aliphatic moiety of suberin (not exclusive, but used as evidence of changing suberin content), Specifically:
  - 2856 cm<sup>-1</sup>  
  - 2930 cm<sup>-1</sup> 
  - 2976 cm<sup>-1</sup> 
- 1737 or 1740 cm<sup>-1</sup> ← suberin esters (but also hemicellulose?)
- 1506 cm<sup>-1</sup> ← aromatic moiety of suberin (also lignin)

### Wheat roots
```{r plotting wheat, message=FALSE, warning=FALSE, fig.width=9, fig.height=6}
palc2 <- c("wk0" = "#B4D586", "wk10" = "#98C559","wk20" = "#79A63A",
           "wk30" = "#58792A", "wk40" = "#374B1B")
wheat <- rootsn %>%
  group_by(timepoint) %>%
  filter(crop == "wheat")

wheat$absorbance <- as.numeric(wheat$absorbance)

wheat_plot <- ggplot(wheat,
                     aes(x = wavenumber,
                         y = absorbance,
                         color = timepoint)) +
  xlim(4000, 1000) +
  geom_line() +
  theme_classic() +
  scale_color_manual(values = palc2) +
  annotate("rect", xmin = 2800, xmax = 3000, ymin = -Inf, ymax = Inf, 
           alpha = 0.1, fill = "gray70", color = "gray60", linewidth = 0.12) +
  geom_vline(xintercept = 2976, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 2930, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 2856, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 1737, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 1506, linetype = "dotted", linewidth = 0.5) +
  ggtitle("Wheat Roots FTIR")
wheat_plot
unique(wheat$ID)
```
### Rice roots
```{r plotting rice, message=FALSE, warning=FALSE, fig.width=9, fig.height=6}
palc3 <- c("wk0" = "#FDB35E", "wk10" = "#FC9D33","wk29" = "#F18204",
           "wk40" = "#B56203")

rice <- rootsn %>%
  group_by(timepoint) %>%
  filter(crop == "rice")

rice <- rice %>%
  group_by(ID) %>%
  filter(ID != "047") # 47 has a weird peak at the start

rice$absorbance <- as.numeric(rice$absorbance)

rice_plot <- ggplot(rice,
                    aes(x = wavenumber,
                        y = absorbance,
                        color = timepoint)) +
  xlim(4000, 1000) +
  ylim(0, 1.5) +
  geom_line() +
  theme_classic() +
  scale_color_manual(values = palc3) +
annotate("rect", xmin = 2800, xmax = 3000, ymin = -Inf, ymax = Inf, 
           alpha = 0.1, fill = "gray70", color = "gray60", linewidth = 0.12) +
  geom_vline(xintercept = 2976, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 2930, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 2856, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 1737, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 1506, linetype = "dotted", linewidth = 0.5) +
  ggtitle("Rice Roots FTIR")
rice_plot
unique(rice$ID)
```
### Soy roots
```{r plotting soy, echo=FALSE, message=FALSE, warning=FALSE, fig.width=9, fig.height=6}
palc4 <- c("wk0" = "#FE71B1", "wk10" = "#FE318E","wk20" = "#F4016E",
           "wk30" = "#B70153", "wk40" = "#7A0137")
soy <- rootsn %>%
  group_by(timepoint) %>%
  filter(crop == "soy") %>%
  filter(ID != "094") # 94 has a huge ~3500 peak compared to other wk10 soy

soy$absorbance <- as.numeric(soy$absorbance)

soy_plot <- ggplot(soy,
                   aes(x = wavenumber,
                       y = absorbance,
                       color = timepoint)) +
  xlim(4000, 1000) +
  geom_line() +
  theme_classic() +
  scale_color_manual(values = palc4) +
annotate("rect", xmin = 2800, xmax = 3000, ymin = -Inf, ymax = Inf, 
           alpha = 0.1, fill = "gray70", color = "gray60", linewidth = 0.12) +
  geom_vline(xintercept = 2976, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 2930, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 2856, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 1737, linetype = "dotted", linewidth = 0.5) +
  geom_vline(xintercept = 1506, linetype = "dotted", linewidth = 0.5) +
  ggtitle("Soy Roots FTIR")
soy_plot
unique(soy$ID)
``` -->