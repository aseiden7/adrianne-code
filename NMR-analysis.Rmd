---
title: "NMR Data Analysis"
author: "Adrianne Seiden"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    theme: darkly
    highlight: zenburn
    code_folding: hide
knit: (function(inputFile, encoding) {
    rmarkdown::render(inputFile, encoding = encoding,
                     output_dir = "../adrianne-code/") })
---

# Overview
This document outlines the steps for analyzing solid-state <sup>13</sup>C CP/MAS NMR spectra using the `SOMnmR` package in R. The package was developed by Luis Colocho at the Technical University of Munich. You can find the package and its documentation here: https://github.com/LuisCol8/SOMnmR and a peer-reviewed publication describing the methods here: https://doi.org/10.1029%2F2024JG008288.

Full citation:
Colocho Hurtarte, L. C., Garcia‐Franco,N., Villalba Ayala, G., Prietzel, J., &Koegel‐Knabner, I. (2025). SOMnmR: An R package for analyzing CP MAS <sup>13</sup>C NMR spectra of environmental samples. *Journal of Geophysical Research: Biogeosciences*, 130, e2024JG008288.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Set CRAN mirror
options(repos = c(CRAN = "https://cloud.r-project.org/"))

# Load required libraries
    # SOMnmR dependencies
library(minpack.lm)
library(quadprog)
library(pracma)
library(ggplot2)
library(dplyr)
library(data.table)
library(IntervalSurgeon)
    # SOMnmR -- main package
library(SOMnmR)

# Set Box path
box_base <- Sys.getenv("BOX_BASE")
if (box_base == "") stop("BOX_BASE environment variable is not set!")

# Set paths
csv_folder <- file.path(box_base, "Salk Institute Project/AKS Salk files/Adrianne_NMR/MNova-CSVs")
outputs_folder <- file.path(box_base, "Salk Institute Project/AKS Salk files/Adrianne_NMR/NMR_analysis_outputs")
```

# Basic Integration of NMR Data
modified from SOMnmR "Basic example" vignette: https://github.com/LuisCol8/SOMnmR/blob/main/how-to-use.md

The following code chunk will load and integrate all CP/MAS <sup>13</sup>C NMR spectra stored as comma-separated value (.csv) files in the specified folder. Note that the resulting integrals are not yet spinning side-band (SSB) corrected. There are  three integration methods available in the `int_nmr` function: "4region", "Bonanomi", and "MMM". 
"4region" divides the spectrum into four chemical shift regions:

<table style="width: auto; border-collapse: collapse; border: 1px solid #f5f5f5;">
<tr>
<td style="padding: 5px; white-space: nowrap; border: 1px solid #f5f5f5;">Alkyl</td>
<td style="padding: 5px; border: 1px solid #f5f5f5;">0--45 ppm</td>
</tr>
<tr>
<td style="padding: 5px; white-space: nowrap; border: 1px solid #f5f5f5;">O/N-Alkyl</td>
<td style="padding: 5px; border: 1px solid #f5f5f5;">45--110 ppm</td>
</tr>
<tr>
<td style="padding: 5px; white-space: nowrap; border: 1px solid #f5f5f5;">Aryl</td>
<td style="padding: 5px; border: 1px solid #f5f5f5;">110--160 ppm</td>
<td style="padding: 5px; white-space: nowrap; border: 1px solid #f5f5f5;">Carboxyl</td>
<td style="padding: 5px; border: 1px solid #f5f5f5;">160--210 ppm</td>
</tr>
</table>


"Bonanomi" uses 7 integration regions defined in [Bonanomi et al., 2011](https://doi.org/10.1111/j.1469-8137.2011.03765.x). This method is used to investigate detailed chemical changes in organic materials, such as during litter decomposition. 

<table style="width: auto; border-collapse: collapse; border: 1px solid #f5f5f5;">
<tr>
<td style="padding: 5px; white-space: nowrap; border: 1px solid #f5f5f5;">Alkyl</td>
<td style="padding: 5px; border: 1px solid #f5f5f5;">0--45 ppm</td>
</tr>
<tr>
<td style="padding: 5px; white-space: nowrap; border: 1px solid #f5f5f5;">N-Alkyl/methoxy</td>
<td style="padding: 5px; border: 1px solid #f5f5f5;">46--60 ppm</td>
</tr>
<tr>
<td style="padding: 5px; white-space: nowrap; border: 1px solid #f5f5f5;">O-Alkyl</td>
<td style="padding: 5px; border: 1px solid #f5f5f5;">61--90 ppm</td>
<td style="padding: 5px; white-space: nowrap; border: 1px solid #f5f5f5;">Di-O-Alkyl</td>
<td style="padding: 5px; border: 1px solid #f5f5f5;">91--110 ppm</td>
</tr>
<tr>
<td style="padding: 5px; white-space: nowrap; border: 1px solid #f5f5f5;">Aromatic</td>
<td style="padding: 5px; border: 1px solid #f5f5f5;">111--140 ppm</td>
<td style="padding: 5px; white-space: nowrap; border: 1px solid #f5f5f5;">Phenolic</td>
<td style="padding: 5px; border: 1px solid #f5f5f5;">141--160 ppm</td>
</tr>
<tr>
<td style="padding: 5px; white-space: nowrap; border: 1px solid #f5f5f5;">Carboxyl</td>
<td style="padding: 5px; border: 1px solid #f5f5f5;">161--190 ppm</td>
</tr>
</table>


The "MMM" method uses a set of seven integration ranges similar to the "Bonanomi" method, tailored for input into the mixing models based on previous work from [Nelson et al. (1999)](https://doi.org/10.1071/S98076), [Baldock et al. (2004)](https://doi.org/10.1016/j.marchem.2004.06.016)  and [Nelson and Baldock (2005)](https://doi.org/10.1007/s10533-004-0076-3). 

<table style="width: auto; border-collapse: collapse; border: 1px solid #f5f5f5;">
<tr>
<td style="padding: 5px; white-space: nowrap; border: 1px solid #f5f5f5;">Alkyl</td>
<td style="padding: 5px; border: 1px solid #f5f5f5;">-10--45 ppm</td>
</tr>
<tr>
<td style="padding: 5px; white-space: nowrap; border: 1px solid #f5f5f5;">N-Alkyl/methoxy</td>
<td style="padding: 5px; border: 1px solid #f5f5f5;">45--60 ppm</td>
</tr>
<tr>
<td style="padding: 5px; white-space: nowrap; border: 1px solid #f5f5f5;">O-Alkyl</td>
<td style="padding: 5px; border: 1px solid #f5f5f5;">60--95 ppm</td>
<td style="padding: 5px; white-space: nowrap; border: 1px solid #f5f5f5;">Di-O-Alkyl</td>
<td style="padding: 5px; border: 1px solid #f5f5f5;">95--110 ppm</td>
</tr>
<tr>
<td style="padding: 5px; white-space: nowrap; border: 1px solid #f5f5f5;">Aromatic</td>
<td style="padding: 5px; border: 1px solid #f5f5f5;">110--145 ppm</td>
<td style="padding: 5px; white-space: nowrap; border: 1px solid #f5f5f5;">Phenolic</td>
<td style="padding: 5px; border: 1px solid #f5f5f5;">145--165 ppm</td>
</tr>
<tr>
<td style="padding: 5px; white-space: nowrap; border: 1px solid #f5f5f5;">Carbonyl</td>
<td style="padding: 5px; border: 1px solid #f5f5f5;">165--210 ppm</td>
</tr>
</table>

To perform the MMM analysis, the SOMnmR package requires two primary inputs: the integrated signal intensities from these regions and the molar C:N values of the samples. For now, since I don't have C:N values for these samples, I will just use the "Bonanomi" method.

```{r load-and-integrate, message=FALSE}
setwd(csv_folder)

## list all the files
files <- list.files()

## list all the files that end with .csv
files <- files[grep(".csv", files)]

# Load data, choose either  "Bruker" (standard Bruker file), "coma" (coma separated value), "tab" (tab separated value)
spec <- read_raw_spec(files, filetype = "coma")

# Integrate the whole data set, NMRmeth can be "4region", "Bonanomi" and "MMM". I will chose Bonanomi.
# For this you will need to input the magnetic field of your NMR machine and the spinning frequency of the probe.
# In this example we used an NMR of 500 MHz and a spinning frequency of 10,000 Hz.

Integralregions <- int_nmr(spec, NMRmeth = "Bonanomi", NMR_field = 500, NMR_rotation = 10000)

#To view the output of a single spectrum
View(Integralregions[[1]][["data"]][["Integral"]])
```
# Correcting for Spinning Side Bands (SSB)
"We now know how to load a spectrum a perform a simple integration. There is a wraped function that performs the integration, and corrects for the SSBs. The example follows"

```{r ssb-correction, message=FALSE}
# load necessary packages
  library(minpack.lm)
  library(quadprog)
  library(pracma)
  library(ggplot2)
  library(data.table)
  library(dplyr)
  library(IntervalSurgeon)
  library(SOMnmR)

# load data
## set working directory
csv_folder <- file.path(box_base, "Salk Institute Project/AKS Salk files/Adrianne_NMR/MNova-CSVs")
outputs_folder <- file.path(box_base, "Salk Institute Project/AKS Salk files/Adrianne_NMR/NMR_analysis_outputs")

## go to directory containing all spectra
setwd(csv_folder)

## list all the files
files <- list.files()

## list all the files that end with .csv
files <- files[grep(".csv", files)]

# Load data, choose either  "Bruker" (standard Bruker file), "coma" (coma separated value), "tab" (tab separated value
spec <- read_raw_spec(files, filetype = "coma")

# Integrate and correct for the SSB of the whole data set, NMRmeth can be "4region", "Bonanomi" and "MMM".
# I will chose Bonanomi.
# For this you will need to input the magnetic field of your NMR machine and the spinning frequency of the probe.
# In this example we used an NMR of 500 MHz and a spinning frequency of 10000 Hz.

IntegralSSBc <- region_calc(spec, NMRmeth = "Bonanomi", NMR_field = 500, NMR_rotation = 10000)

#To view the output of a single spectrum
View(IntegralSSBc[[1]])

#If you want to generate a table with all the results insead of having each in a list you can try this
Integrall <- NULL
for (i in 1:length(IntegralSSBc)) {
  Integral <- data.frame(IntegralSSBc[[i]])
  
  Integrall <- rbind(Integrall, Integral)
}
View(Integrall)
