---
title: "NMR Data Analysis"
author: "Adrianne Seiden"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    theme: darkly
    highlight: zenburn
    code_folding: hide
knit: (function(inputFile, encoding) {
    rmarkdown::render(inputFile, encoding = encoding,
                     output_dir = "../adrianne-code/") })
---

# Overview
This document outlines the steps for analyzing solid-state <sup>13</sup>C CP/MAS NMR spectra using the `SOMnmR` package in R. The package was developed by Luis Colocho at the Technical University of Munich. You can find the package and its documentation here: https://github.com/LuisCol8/SOMnmR and a peer-reviewed publication describing the methods here: https://doi.org/10.1029%2F2024JG008288.

Full citation:
Colocho Hurtarte, L. C., Garcia‐Franco,N., Villalba Ayala, G., Prietzel, J., &Koegel‐Knabner, I. (2025). SOMnmR: An R package for analyzing CP MAS <sup>13</sup>C NMR spectra of environmental samples. *Journal of Geophysical Research: Biogeosciences*, 130, e2024JG008288.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Set CRAN mirror
options(repos = c(CRAN = "https://cloud.r-project.org/"))

# Load required libraries
    # SOMnmR dependencies
library(minpack.lm)
library(quadprog)
library(pracma)
library(ggplot2)
library(dplyr)
library(data.table)
library(IntervalSurgeon)
    # SOMnmR -- main package
library(SOMnmR)
    # For better table formatting
if (!require(kableExtra)) install.packages("kableExtra")
library(kableExtra)

# Set Box path
box_base <- Sys.getenv("BOX_BASE")
if (box_base == "") stop("BOX_BASE environment variable is not set!")

# Set paths
csv_folder <- file.path(box_base, "Salk Institute Project/AKS Salk files/Adrianne_NMR/MNova-CSVs")
outputs_folder <- file.path(box_base, "Salk Institute Project/AKS Salk files/Adrianne_NMR/NMR_analysis_outputs")
```

<style>
/* Scoped narrow table styles with !important to override theme */
.nmr-narrow table {
    border-collapse: collapse !important;
    table-layout: fixed !important;
    width: 290px !important;
    max-width: 300px !important;
}
.nmr-narrow table th, .nmr-narrow table td {
    padding: 6px !important;
    border: 0.6px solid #545454 !important;
    /* text-align: left !important; */
}
.nmr-narrow table th:nth-child(1), .nmr-narrow table td:nth-child(1) { width: 150px !important; }
.nmr-narrow table th:nth-child(2), .nmr-narrow table td:nth-child(2) { width: 140px !important; }
/* Banded rows - more visible on dark theme */
.nmr-narrow table tbody tr:nth-child(odd) { background-color: rgba(255, 255, 255, 0.02) !important; }
.nmr-narrow table tbody tr:nth-child(even) { background-color: rgba(255, 255, 255, 0.09) !important; }
</style>

# Basic Integration of NMR Data
modified from SOMnmR "Basic example" vignette: https://github.com/LuisCol8/SOMnmR/blob/main/how-to-use.md

The following code chunk will load and integrate all CP/MAS <sup>13</sup>C NMR spectra stored as comma-separated value (.csv) files in the specified folder. Note that the resulting integrals are not yet spinning side-band (SSB) corrected. There are  three integration methods available in the `int_nmr` function: "4region", "Bonanomi", and "MMM". 
"4region" divides the spectrum into four chemical shift regions:

<div class="nmr-narrow">

|        |       |
|--------|-------|
| Alkyl | 0–45 ppm |
| O/N-Alkyl | 45–110 ppm |
| Aryl | 110–160 ppm |
| Carboxyl | 160–210 ppm |

</div>

"Bonanomi" uses 7 integration regions defined in [Bonanomi et al., 2011](https://doi.org/10.1111/j.1469-8137.2011.03765.x). This method is used to investigate detailed chemical changes in organic materials, such as during litter decomposition. 

<div class="nmr-narrow">

|        |       |
|--------|-------|
| Alkyl | 0–45 ppm |
| N-Alkyl/methoxy | 46–60 ppm |
| O-Alkyl | 61–90 ppm |
| Di-O-Alkyl | 91–110 ppm |
| Aromatic | 111–140 ppm |
| Phenolic | 141–160 ppm |
| Carboxyl | 161–190 ppm |

</div>

The "MMM" method uses a set of seven integration ranges similar to the "Bonanomi" method, tailored for input into the mixing models based on previous work from [Nelson et al. (1999)](https://doi.org/10.1071/S98076), [Baldock et al. (2004)](https://doi.org/10.1016/j.marchem.2004.06.016)  and [Nelson and Baldock (2005)](https://doi.org/10.1007/s10533-004-0076-3). 

<div class="nmr-narrow">

|        |       |
|--------|-------|
| Alkyl | −10–45 ppm |
| N-Alkyl/methoxy | 45–60 ppm |
| O-Alkyl | 60–95 ppm |
| Di-O-Alkyl | 95–110 ppm |
| Aromatic | 110–145 ppm |
| Phenolic | 145–165 ppm |
| Carbonyl | 165–210 ppm |

</div>

To perform the MMM analysis, the SOMnmR package needs both the integrated signal intensities and the molar C:N values of the samples. For now, since I don't have C:N values for these samples, I will just use the "Bonanomi" method. Note that Phung et al. (in review) uses the MMM integration regions for their A/O-A and RDR calculations (with the exception of 'Alkyl' being from 0 to 45 ppm rather than -10 to 45 ppm and 'Carbonyl' being from 165 to 215 ppm rather than 165 to 210 ppm).

```{r load-and-integrate, message=FALSE}
setwd(csv_folder)

## list all the files
files <- list.files()

## list all the files that end with .csv
files <- files[grep("\\.csv$", files)]

# Load data, choose either  "Bruker" (standard Bruker file), "coma" (coma separated value), "tab" (tab separated value) 
spec <- read_raw_spec(files, filetype = "coma")

# Integrate the whole data set, NMRmeth can be "4region", "Bonanomi" and "MMM". I will chose Bonanomi.
# For this you will need to input the magnetic field of your NMR machine and the spinning frequency of the probe.
# In this example we used an NMR of 500 MHz and a spinning frequency of 10,000 Hz.

# Suppress progress bar output
invisible(capture.output(
  Integralregions <- int_nmr(spec, NMRmeth = "Bonanomi", NMR_field = 500, NMR_rotation = 10000)
))

# Display results in the knitted output
print(paste("Integrated", length(Integralregions), "spectra"))

# Show the first spectrum's integral table
integral_table <- Integralregions[[1]][["data"]][["Integral"]]
# Round numeric columns to 3 decimal places
integral_table[] <- lapply(integral_table, function(x) if(is.numeric(x)) round(x, 3) else x)
knitr::kable(integral_table, 
             caption = "Example: Integral regions for first spectrum")
```

# Correcting for Spinning Side Bands (SSB)
"We now know how to load a spectrum a perform a simple integration. There is a wraped function that performs the integration, and corrects for the SSBs. The example follows"

```{r ssb-correction, message=FALSE}
# load necessary packages
  library(minpack.lm)
  library(quadprog)
  library(pracma)
  library(ggplot2)
  library(data.table)
  library(dplyr)
  library(IntervalSurgeon)
  library(SOMnmR)

# load data
## set working directory
csv_folder <- file.path(box_base, "Salk Institute Project/AKS Salk files/Adrianne_NMR/MNova-CSVs")
outputs_folder <- file.path(box_base, "Salk Institute Project/AKS Salk files/Adrianne_NMR/NMR_analysis_outputs")

## go to directory containing all spectra
setwd(csv_folder)

## list all the files
files <- list.files()

## list all the files that end with .csv
files <- files[grep("\\.csv$", files)]

# Load data, choose either  "Bruker" (standard Bruker file), "coma" (coma separated value), "tab" (tab separated value
spec <- read_raw_spec(files, filetype = "coma")

# Integrate and correct for the SSB of the whole data set, NMRmeth can be "4region", "Bonanomi" and "MMM".
# I will chose Bonanomi.
# For this you will need to input the magnetic field of your NMR machine and the spinning frequency of the probe.
# For this research I used an NMR of 500 MHz and a spinning frequency of 10000 Hz.

# Suppress progress bar output
invisible(capture.output(
  IntegralSSBc <- region_calc(spec, NMRmeth = "Bonanomi", NMR_field = 500, NMR_rotation = 10000)
))

# Convert character columns to numeric in each data frame (except 'name')
IntegralSSBc <- lapply(IntegralSSBc, function(df) {
  for(col in names(df)) {
    if(col != "name") {
      df[[col]] <- as.numeric(df[[col]])
    }
  }
  return(df)
})
#To view the output of a single spectrum
# View(IntegralSSBc[[1]])

# Round and display first spectrum
ssb_table <- IntegralSSBc[[1]]
ssb_table[] <- lapply(ssb_table, function(x) if(is.numeric(x)) round(x, 3) else x)
knitr::kable(ssb_table, 
             caption = "Example: SSB-corrected output for a single spectrum")

#Generate a table with all the results instead of having each in a list
Integrall <- NULL
for (i in 1:length(IntegralSSBc)) {
  Integral <- data.frame(IntegralSSBc[[i]], stringsAsFactors = FALSE)
  Integrall <- rbind(Integrall, Integral)
}

# Convert all columns except 'name' to numeric and round to 3 decimals
for(col in names(Integrall)) {
  if(col != "name") {
    Integrall[[col]] <- round(as.numeric(Integrall[[col]]), 3)
  }
}

# Display all results
knitr::kable(Integrall, 
             caption = "Results table: All spectra SSB-corrected integrals") %>%
  kableExtra::kable_styling()

# Save the results as a .csv file
write.csv(Integrall, file.path(outputs_folder, "NMR_SSB_corrected_integrals_Bonanomi.csv"), row.names = FALSE)
```
# Make a plot
"There is a quick plot function that separates the regions of the spectrum." -- I modified plot_NMR to plot 230 to -20 ppm instead of 400 to -200 ppm, set the y-minimum at -0.1 (instead of -5), and use the sample names as plot titles.

```{r plot-nmr, message=FALSE, fig.width=10, fig.height=8, results='hide'}
# load necessary packages
  library(ggplot2)
  library(SOMnmR)

# Source the custom function from adrianne-code directory (use absolute path)
source(file.path(dirname(getwd()), "adrianne-code", "plot_NMR_edit.R"))

# Set working directory to outputs folder for plot saving
setwd(outputs_folder)

# Generate plots - they will be saved to outputs_folder and displayed in HTML
plot_NMR_aks(spec, NMRmeth = "Bonanomi", file.output = TRUE , use.tiff = FALSE)

# Return to original directory
setwd(csv_folder)
```

# Calculate Alkyl/O-Alkyl Ratios (A/O-A) and Resistance-to-Decomposition Ratios (RDR). 
A/O-A ratio is calculated as the ratio of the integrated signal intensities in the alkyl-C (**0--45 ppm**) and O-alkyl-C (**61--90 ppm**) regions, according to the Bonanomi method. Note that Phung et al. (in review) uses **60--95 ppm** as the O-alkyl region, which is more similar to the MMM integration.

RDR is calculated according to Phung et al. (in review):  **(alkyl + aromatic + phenolic)/(O-alkyl + carboxyl + carbonyl)**.  
Using the Bonanomi integration regions, this corresponds to  **(0--45 ppm + 111-160 ppm)/(61--90 ppm + 161--190 ppm)**,  but Phung et al. (in review) uses  **(0--45 ppm + 110--165 ppm)/(60--95 ppm + 165--215 ppm)**  for their calculations.

```{r calculate-ratios, message=FALSE, warning=FALSE}
# Read the SSB-corrected integrals CSV
ratios_df <- read.csv(file.path(outputs_folder, "NMR_SSB_corrected_integrals_Bonanomi.csv"))

# Calculate alkyl/O-alkyl ratio
ratios_df$Alkyl_O.Alkyl_Ratio <- ratios_df$Alkyl / ratios_df$O.Alkyl

# Round the new ratio column to 3 decimal places
ratios_df$Alkyl_O.Alkyl_Ratio <- round(ratios_df$Alkyl_O.Alkyl_Ratio, 3)

# Calculate RDR
ratios_df$RDR <- (ratios_df$Alkyl + ratios_df$Aromatic + ratios_df$Phenolic) / (ratios_df$O.Alkyl + ratios_df$Amide.Carboxyl)

# Round the new ratio column to 3 decimal places
ratios_df$RDR <- round(ratios_df$RDR, 3)

# Save updated CSV with ratios
write.csv(ratios_df, file.path(outputs_folder, "NMR_SSB_corrected_integrals_Bonanomi.csv"), row.names = FALSE)

# Extract crop and timepoint from sample names
# Assuming format like "AS1_noPlant_wk0" or similar
ratios_df$crop <- sub(".*(noPlant|wheat|rice|soy)_.*", "\\1", ratios_df$name)
ratios_df$timepoint <- sub(".*_(wk[0-9]+).*", "\\1", ratios_df$name)

# Calculate mean alkyl/O-alkyl ratio grouped by crop and timepoint
ratio_means <- ratios_df %>%
  group_by(crop, timepoint) %>%
  summarise(
    n_samples = n(),
    mean_Alkyl_O.Alkyl = round(mean(Alkyl_O.Alkyl_Ratio, na.rm = TRUE), 3),
    sd_Alkyl_O.Alkyl = round(sd(Alkyl_O.Alkyl_Ratio, na.rm = TRUE), 3),
    mean_RDR = round(mean(RDR, na.rm = TRUE), 3),
    sd_RDR = round(sd(RDR, na.rm = TRUE), 3),
    .groups = 'drop'
  )

# Display the results
knitr::kable(ratio_means, 
             caption = "Mean Alkyl/O-Alkyl and RDR by Crop and Timepoint") %>%
  kableExtra::kable_styling()

# Save the summary table
write.csv(ratio_means, file.path(outputs_folder, "NMR_ratio_means.csv"), row.names = FALSE)
```

# Plot A/O-A and RDR Over Time
Create stacked violin/box plots showing alkyl/O-alkyl ratios across timepoints for each crop type.
Create stacked violin/box plots showing RDR across timepoints for each crop type.

```{r plot-ratios, message=FALSE, warning=FALSE, fig.width=11, fig.height=7}
library(ggplot2)

# Define color scheme
crop_timepoint_colors <- list(
  wheat = c("wk0" ="#D8B1FB", "wk10" = "#BD7EF6", "wk40" = "#49236C"),
  rice = c("wk0" = "#FDAC50", "wk10" = "#F08F20", "wk40" = "#B56203"),
  soy = c("wk0" = "#FE71B1", "wk10" = "#FE318E", "wk40" = "#7A0137")
)

# Filter out noPlant and prepare data
plot_data <- ratios_df %>%
  filter(crop %in% c("wheat", "rice", "soy")) %>%
  mutate(
    crop = factor(crop, levels = c("soy", "rice", "wheat")),
    timepoint_num = as.numeric(gsub("wk", "", timepoint)),
    crop_time = paste(crop, timepoint, sep = "_")
  )

# Create named color vector for all crop-timepoint combinations
color_mapping <- c(
  "soy_wk0" = "#FE5CA5",
  "soy_wk10" = "#DD2578",
  "soy_wk40" = "#9B0D4D",
  "rice_wk0" = "#FDAC50",
  "rice_wk10" = "#F08F20",
  "rice_wk40" = "#B56203",
  "wheat_wk0" = "#d2a9f6",
  "wheat_wk10" = "#BD7EF6",
  "wheat_wk40" = "#49236C"
)
crop_color <- c("soy" = "#FE318E", "rice" = "#FC9D33", "wheat" = "#884EBB")

# Calculate means for each crop-timepoint combination
plot_means <- plot_data %>%
  group_by(crop, timepoint_num) %>%
  summarise(mean_ratio = mean(Alkyl_O.Alkyl_Ratio, na.rm = TRUE), .groups = 'drop')

# Create the A/O-A plot
p <- ggplot(plot_data, aes(x = timepoint_num, y = Alkyl_O.Alkyl_Ratio, fill = crop, color = crop)) +
  geom_jitter(width = 1.2, height = 0, alpha = 0.9, size = 4.5) +
  geom_point(data = plot_means, aes(x = timepoint_num, y = mean_ratio, color = crop),
             shape = 4, size = 5.2, stroke = 2, show.legend = FALSE) +
  # Add a dummy point for legend only
  geom_point(aes(shape = "Mean"), x = NA, y = NA, color = "black", size = 5.2, stroke = 2) +
  geom_smooth(aes(group = crop, color = crop), 
              method = "lm", se = FALSE, linetype = "dashed", 
              linewidth = 0.7) +
  scale_x_continuous(breaks = c(0, 10, 40)) +
  scale_fill_manual(values = crop_color, name = NULL, guide = "none") +
  scale_color_manual(values = crop_color, name = NULL, 
                     guide = guide_legend(order = 1, override.aes = list(shape = 16, size = 4.5))) +
  scale_shape_manual(values = 4, name = NULL,
                     guide = guide_legend(order = 2, override.aes = list(size = 5.2, stroke = 2))) +
  labs(
    x = "Time (weeks)",
    y = "Alkyl/O-Alkyl Ratio",
    title = "Alkyl/O-Alkyl Ratios Across Timepoints by Crop Type"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    legend.text = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 14.5, face = "bold"),
    axis.text = element_text(size = 14.5, face = "bold"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()
  )

# Display the plot
print(p)

# Save the plot
ggsave(filename = file.path(outputs_folder, "Alkyl_O-Alkyl_ratio_by_crop_timepoint.png"),
       plot = p, width = 11, height = 7, dpi = 300)
###########################################################################################

# Create the RDR plot
# Calculate means for each crop-timepoint combination
rdr_means <- plot_data %>%
  group_by(crop, timepoint_num) %>%
  summarise(mean_rdr = mean(RDR, na.rm = TRUE), .groups = 'drop')

p1 <- ggplot(plot_data, aes(x = timepoint_num, y = RDR, fill = crop, color = crop)) +
  geom_jitter(width = 1.2, height = 0, alpha = 0.9, size = 4.5) +
    geom_point(data = rdr_means, aes(x = timepoint_num, y = mean_rdr, color = crop),
             shape = 4, size = 5.2, stroke = 2, show.legend = FALSE) +
  # Add a dummy point for legend only
  geom_point(aes(shape = "Mean"), x = NA, y = NA, color = "black", size = 5.2, stroke = 2) +
  geom_smooth(aes(group = crop, color = crop), 
              method = "lm", se = FALSE, linetype = "dashed", 
              linewidth = 0.7) +
  scale_x_continuous(breaks = c(0, 10, 40)) +
  scale_fill_manual(values = crop_color, name = NULL, guide = "none") +
  scale_color_manual(values = crop_color, name = NULL, 
                     guide = guide_legend(order = 1, override.aes = list(shape = 16, size = 4.5))) +
  scale_shape_manual(values = 4, name = NULL,
                     guide = guide_legend(order = 2, override.aes = list(size = 5.2, stroke = 2))) +
  labs(
    x = "Time (weeks)",
    y = "Resistance-to-Decomposition Ratio (RDR)",
    title = "Resistance-to-Decomposition Ratio (RDR) Across Timepoints by Crop Type"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    legend.text = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 14.5, face = "bold"),
    axis.text = element_text(size = 14.5, face = "bold"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()
  )

# Display the plot
print(p1)

# Save the plot
ggsave(filename = file.path(outputs_folder, "RDR_by_crop_timepoint.png"),
       plot = p1, width = 11, height = 7, dpi = 300)

```
# Plot RDR against A/O-a


# Plot Averaged NMR Spectra by Crop and Timepoint

Create plots showing mean NMR spectra for each crop-timepoint combination with standard deviation and full range. The solid line represents the mean spectrum, the medium transparency ribbon represents ±1 standard deviation, and the most transparent ribbon represents the full range (min to max) of spectra at each ppm value (may be the same as ±1 standard deviation).

```{r plot-averaged-spectra, message=FALSE, warning=FALSE, fig.width=12, fig.height=6}
library(ggplot2)
library(dplyr)
library(tidyr)

# Define color scheme
crop_timepoint_colors <- list(
  wheat = c("wk0" = "#D8B1FB", "wk10" = "#BD7EF6", "wk40" = "#49236C"),
  rice = c("wk0" = "#FDB35E", "wk10" = "#FC9D33", "wk40" = "#B56203"),
  soy = c("wk0" = "#FE71B1", "wk10" = "#FE318E", "wk40" = "#7A0137")
)

# Extract all spectra into a data frame
spectra_list <- lapply(seq_along(spec), function(i) {
  df <- spec[[i]]$data$raw.spec
  # Select ppm and raw.intensity columns and rename
  df <- data.frame(
    ppm = df$ppm,
    intensity = df$raw.intensity,
    sample_name = spec[[i]]$name
  )
  return(df)
})

spectra_df <- bind_rows(spectra_list)

# Extract crop and timepoint from sample names
spectra_df$crop <- sub(".*(noPlant|wheat|rice|soy)_.*", "\\1", spectra_df$sample_name)
spectra_df$timepoint <- sub(".*_(wk[0-9]+).*", "\\1", spectra_df$sample_name)

# Filter for crops of interest and ppm range
spectra_filtered <- spectra_df %>%
  filter(crop %in% c("wheat", "rice", "soy"),
         ppm >= -10 & ppm <= 230) %>%
  mutate(crop = factor(crop, levels = c("wheat", "rice", "soy")))

# Calculate statistics by crop, timepoint, and ppm
spectra_stats <- spectra_filtered %>%
  group_by(crop, timepoint, ppm) %>%
  summarise(
    mean_intensity = mean(intensity),
    sd_intensity = sd(intensity),
    min_intensity = min(intensity),
    max_intensity = max(intensity),
    .groups = 'drop'
  ) %>%
  mutate(
    upper_sd = mean_intensity + sd_intensity,
    lower_sd = mean_intensity - sd_intensity,
    crop_time = paste(crop, timepoint, sep = "_")
  )

# Create color mapping
color_map <- c(
  "soy_wk0" = "#FE5CA5",
  "soy_wk10" = "#DD2578",
  "soy_wk40" = "#9B0D4D",
  "rice_wk0" = "#FDAC50",
  "rice_wk10" = "#F08F20",
  "rice_wk40" = "#B56203",
  "wheat_wk0" = "#d2a9f6",
  "wheat_wk10" = "#BD7EF6",
  "wheat_wk40" = "#49236C"
)

# Create the plot
p_spectra <- ggplot(spectra_stats, aes(x = ppm, y = mean_intensity, color = crop_time, fill = crop_time)) +
  # Full range (most transparent)
  geom_ribbon(aes(ymin = min_intensity, ymax = max_intensity), alpha = 0.19, color = NA) +
  # +/- 1 SD (medium transparency)
  geom_ribbon(aes(ymin = lower_sd, ymax = upper_sd), alpha = 0.44, color = NA) +
  # Mean line (solid)
  geom_line(linewidth = 0.8) +
  facet_grid(timepoint ~ crop, scales = "free_y") +
  scale_x_reverse() +
  scale_color_manual(values = color_map) +
  scale_fill_manual(values = color_map) +
  labs(
    x = "Chemical Shift (ppm)",
    y = "Normalized Intensity",
    title = "Average NMR Spectra by Crop and Timepoint"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    strip.text = element_text(size = 14, face = "bold"),
    strip.text.y = element_text(margin = margin(t = 130, r = 1, b = 0, l = 0)),
    axis.title = element_text(size = 13),
    axis.text.x = element_text(size = 12, face = "bold"),
    axis.text.y = element_blank(),
    panel.spacing.x = unit(0, "cm"),
    panel.spacing.y = unit(-3.3, "cm"),
    panel.grid = element_blank()
  )

# Display the plot
print(p_spectra)

# Save the plot
ggsave(filename = file.path(outputs_folder, "NMR_spectra_averaged_by_crop_timepoint.png"),
       plot = p_spectra, width = 12, height = 6, dpi = 300)
```

# Plot Alkyl & Alkyl-Suberin Region

Create zoomed-in plots of the alkyl region (0--45 ppm) and alkyl-suberin region (27--36 ppm) with reference lines at 30 and 33 ppm.

```{r plot-alkyl-zoom, message=FALSE, warning=FALSE, fig.width=12, fig.height=6}
# Filter data for alkyl region (0-45 ppm)
spectra_stats_alkyl <- spectra_stats %>%
  filter(ppm >= -1 & ppm <= 46)

# Create the zoomed plot
p_alkyl <- ggplot(spectra_stats_alkyl, aes(x = ppm, y = mean_intensity, color = crop_time, fill = crop_time)) +
  # Full range (most transparent)
  geom_ribbon(aes(ymin = min_intensity, ymax = max_intensity), alpha = 0.19, color = NA) +
  # +/- 1 SD (medium transparency)
  geom_ribbon(aes(ymin = lower_sd, ymax = upper_sd), alpha = 0.44, color = NA) +
  # Mean line (solid)
  geom_line(linewidth = 0.8) +
  # Add vertical reference lines
  geom_vline(xintercept = 33, linetype = "dotted", color = "#555555", linewidth = 0.65) +
  geom_vline(xintercept = 30, linetype = "dotted", color = "#555555", linewidth = 0.65) +
  facet_grid(timepoint ~ crop, scales = "free_y") +
  scale_x_reverse() +
  scale_color_manual(values = color_map) +
  scale_fill_manual(values = color_map) +
  labs(
    x = "Chemical Shift (ppm)",
    y = "Intensity",
    title = "Zoomed NMR Spectra: Alkyl Region (0-45 ppm)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    strip.text = element_text(size = 14, face = "bold"),
    strip.text.y = element_text(margin = margin(t = 120, r = 1, b = 0, l = 0)),
    axis.title = element_text(size = 13),
    axis.text.x = element_text(size = 12, face = "bold"),
    axis.text.y = element_blank(),
    panel.spacing.x = unit(0, "cm"),
    panel.spacing.y = unit(-3.3, "cm"),
    panel.grid = element_blank()
  )

# Display the plot
print(p_alkyl)

# Save the plot
ggsave(filename = file.path(outputs_folder, "NMR_spectra_alkyl_region_0-45ppm.png"),
       plot = p_alkyl, width = 12, height = 6, dpi = 300)

#############################################################################################
# Just suberin region (30-33 ppm)
############################################################################

spectra_stats_aSub <- spectra_stats %>%
  filter(ppm >= 16 & ppm <= 40)

# Create the zoomed plot
p_aSub <- ggplot(spectra_stats_aSub, aes(x = ppm, y = mean_intensity, color = crop_time, fill = crop_time)) +
  # Full range (most transparent)
  geom_ribbon(aes(ymin = min_intensity, ymax = max_intensity), alpha = 0.19, color = NA) +
  # +/- 1 SD (medium transparency)
  geom_ribbon(aes(ymin = lower_sd, ymax = upper_sd), alpha = 0.44, color = NA) +
  # Mean line (solid)
  geom_line(linewidth = 0.8) +
  # Add vertical reference lines
  geom_vline(xintercept = 33, linetype = "dotted", color = "#555555", linewidth = 0.65) +
  geom_vline(xintercept = 30, linetype = "dotted", color = "#555555", linewidth = 0.65) +
  facet_grid(timepoint ~ crop, scales = "free_y") +
  scale_x_reverse() +
  scale_color_manual(values = color_map) +
  scale_fill_manual(values = color_map) +
  labs(
    x = "Chemical Shift (ppm)",
    y = "Intensity",
    title = "Alkyl Suberin Region"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    strip.text = element_text(size = 14, face = "bold"),
    strip.text.y = element_text(margin = margin(t = 40, r = 1, b = -60, l = 0)),
    axis.title = element_text(size = 13),
    axis.text.x = element_text(size = 12, face = "bold"),
    axis.text.y = element_blank(),
    panel.spacing.x = unit(0, "cm"),
    panel.spacing.y = unit(-3.3, "cm"),
    panel.grid = element_blank()
  )

# Display the plot
print(p_aSub)

# Save the plot
ggsave(filename = file.path(outputs_folder, "NMR_spectra_aSub_16-40ppm.png"),
       plot = p_aSub, width = 12, height = 6, dpi = 300)
```

